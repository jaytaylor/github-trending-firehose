name: scrape-developer

on:
  push:
    paths-ignore:
      - "archive/**"
    branches:
      - main
  schedule:
    - cron: "10 * * * *"
  workflow_dispatch:

concurrency:
  group: archive-update-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  scrape-developer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Resolve Pacific time window
        id: pacific_time
        run: |
          tz="America/Los_Angeles"
          echo "PACIFIC_DATE=$(TZ=$tz date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "PACIFIC_YEAR=$(TZ=$tz date +'%Y')" >> $GITHUB_ENV
          echo "PACIFIC_HOUR=$(TZ=$tz date +'%H')" >> $GITHUB_ENV
      - name: Check if archive directory for today exists
        id: check_today_archive_directory
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "schedule" ] && [ "${PACIFIC_HOUR}" -lt 12 ]; then
            echo "should_scrape_today=false" >> $GITHUB_ENV
            echo "skip_reason=before_noon_pacific" >> $GITHUB_ENV
            exit 0
          fi
          today_dir="archive/developer/${PACIFIC_YEAR}/${PACIFIC_DATE}"
          if [ -d "$today_dir" ]; then
            echo "should_scrape_today=false" >> $GITHUB_ENV
            echo "skip_reason=archive_exists" >> $GITHUB_ENV
          else
            echo "should_scrape_today=true" >> $GITHUB_ENV
          fi
      - uses: actions/setup-node@v4
        if: env.should_scrape_today == 'true'
        with:
          node-version: "16"
          cache: "npm"
      - run: npm ci
        if: env.should_scrape_today == 'true'
      - run: npm run start scrape developer $(pwd)/archive/developer/${PACIFIC_YEAR}/${PACIFIC_DATE}
        if: env.should_scrape_today == 'true'
      - run: git status
        if: env.should_scrape_today == 'true'
      - name: Commit and push changes
        if: env.should_scrape_today == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add archive
          git commit -m "chore: update developer archive ${PACIFIC_DATE}"
          git push origin main
      - uses: actions/upload-artifact@v4
        if: env.should_scrape_today == 'true'
        with:
          name: screenshots
          path: "./debug/*.png"
